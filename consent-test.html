<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Consentement - Projet R√©surgence</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }

        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .granted {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .denied {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        button {
            background: #D5B654;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem;
        }

        button:hover {
            background: #B89A3D;
        }

        .test-buttons {
            margin: 2rem 0;
        }

        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>üß™ Test de Consentement Analytics</h1>
    <p>Cette page teste l'impl√©mentation du consentement Axeptio pour Google Analytics.</p>

    <div id="consent-status" class="status denied">
        <strong>Statut du consentement:</strong> <span id="status-text">En attente...</span>
    </div>

    <div class="test-buttons">
        <h3>Tests Analytics:</h3>
        <button onclick="testEvent()">üéØ Tester un √©v√©nement</button>
        <button onclick="testPageView()">üìÑ Tester page view</button>
        <button onclick="testPerformance()">‚ö° Tester performance</button>
        <button onclick="checkConsent()">üîç V√©rifier consentement</button>
        <button onclick="clearLog()">üßπ Vider le log</button>
    </div>

    <div>
        <h3>Log des √©v√©nements:</h3>
        <div id="log"></div>
    </div>

    <!-- Axeptio Consent Management -->
    <script>
        window.axeptioSettings = {
            clientId: "68963e315d089c7b7334b5d1",
            cookiesVersion: "projet-resurgence-fr",
            googleConsentMode: true
        };

        (function (d, s) {
            var t = d.getElementsByTagName(s)[0], e = d.createElement(s);
            e.async = true; e.src = "//static.axept.io/sdk.js";
            t.parentNode.insertBefore(e, t);
        })(document, "script");
    </script>

    <!-- Google Analytics with Consent -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }

        // Set default consent
        gtag('consent', 'default', {
            'analytics_storage': 'denied',
            'ad_storage': 'denied',
            'wait_for_update': 500
        });

        let analyticsLoaded = false;

        function loadGTM() {
            if (analyticsLoaded) return;
            (function (w, d, s, l, i) {
                w[l] = w[l] || []; w[l].push({
                    'gtm.start': new Date().getTime(), event: 'gtm.js'
                }); var f = d.getElementsByTagName(s)[0],
                    j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                        'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
            })(window, document, 'script', 'dataLayer', 'GTM-WDG77HQC');
            analyticsLoaded = true;
            log('üìä Google Tag Manager charg√©');
        }

        function initializeAnalytics() {
            gtag('js', new Date());
            gtag('config', 'GTM-WDG77HQC', {
                send_page_view: true,
                custom_parameters: {
                    content_group1: 'Test Page',
                    content_group2: 'Consent Testing',
                    content_group3: 'Development'
                }
            });
            log('üöÄ Google Analytics initialis√©');
        }

        // Listen for consent events
        window.addEventListener('axeptio_all_vendors', function (e) {
            log('üìã √âv√©nement de consentement re√ßu: ' + JSON.stringify(e.detail));
            if (e.detail.google_analytics) {
                gtag('consent', 'update', {
                    'analytics_storage': 'granted'
                });
                loadGTM();
                initializeAnalytics();
                updateConsentStatus(true);
                log('‚úÖ Consentement accord√© - Analytics activ√©');
            } else {
                updateConsentStatus(false);
                log('‚ùå Consentement refus√© - Analytics d√©sactiv√©');
            }
        });

        // Check existing consent
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                checkConsent();
            }, 2000);
        });

        // Test functions
        function checkConsent() {
            if (window.axeptio && window.axeptio.isConsentGiven) {
                const hasConsent = window.axeptio.isConsentGiven('google_analytics');
                updateConsentStatus(hasConsent);
                log('üîç V√©rification consentement: ' + (hasConsent ? 'Accord√©' : 'Refus√©'));

                if (hasConsent && !analyticsLoaded) {
                    gtag('consent', 'update', {
                        'analytics_storage': 'granted'
                    });
                    loadGTM();
                    initializeAnalytics();
                }
            } else {
                log('‚è≥ Axeptio pas encore charg√©');
                updateConsentStatus(false);
            }
        }

        function updateConsentStatus(granted) {
            const statusDiv = document.getElementById('consent-status');
            const statusText = document.getElementById('status-text');

            if (granted) {
                statusDiv.className = 'status granted';
                statusText.textContent = 'Accord√© ‚úÖ';
            } else {
                statusDiv.className = 'status denied';
                statusText.textContent = 'Refus√© ‚ùå';
            }
        }

        function testEvent() {
            const eventName = 'test_event_' + Date.now();
            log('üéØ Test √©v√©nement: ' + eventName);

            if (window.axeptio && window.axeptio.isConsentGiven && window.axeptio.isConsentGiven('google_analytics')) {
                gtag('event', eventName, {
                    event_category: 'Test',
                    event_label: 'Consent Test',
                    value: 1,
                    custom_parameters: {
                        test_type: 'manual',
                        timestamp: new Date().toISOString()
                    }
                });
                log('‚úÖ √âv√©nement envoy√© √† GA4: ' + eventName);
            } else {
                log('‚ùå √âv√©nement bloqu√© - pas de consentement');
            }
        }

        function testPageView() {
            log('üìÑ Test page view');
            if (window.axeptio && window.axeptio.isConsentGiven && window.axeptio.isConsentGiven('google_analytics')) {
                gtag('event', 'page_view', {
                    page_title: 'Consent Test Page',
                    page_location: window.location.href
                });
                log('‚úÖ Page view envoy√©e √† GA4');
            } else {
                log('‚ùå Page view bloqu√©e - pas de consentement');
            }
        }

        function testPerformance() {
            log('‚ö° Test m√©trique de performance');
            if (window.axeptio && window.axeptio.isConsentGiven && window.axeptio.isConsentGiven('google_analytics')) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                gtag('event', 'page_load_time', {
                    event_category: 'Performance',
                    event_label: 'Test Load Time',
                    value: loadTime,
                    custom_parameters: {
                        load_time_ms: loadTime,
                        test_mode: true
                    }
                });
                log('‚úÖ M√©trique performance envoy√©e: ' + loadTime + 'ms');
            } else {
                log('‚ùå M√©trique bloqu√©e - pas de consentement');
            }
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Initial log
        log('üöÄ Page de test charg√©e');
    </script>
</body>

</html>